'use client';

import { useState } from 'react';
import { useAccount, useWalletClient, usePublicClient } from 'wagmi';
import { parseEther, isAddress } from 'viem';
import { multiSigWalletABI } from '@/lib/abi';

interface DeploySafeProps {
  onBack?: () => void;
}

export function DeploySafe({ onBack }: DeploySafeProps) {
  const { address } = useAccount();
  const { data: walletClient } = useWalletClient();
  const publicClient = usePublicClient();

  const [owners, setOwners] = useState<string[]>([address || '']);
  const [requiredConfirmations, setRequiredConfirmations] = useState(1);
  const [isDeploying, setIsDeploying] = useState(false);
  const [deployedAddress, setDeployedAddress] = useState<string>('');
  const [error, setError] = useState('');

  const addOwner = () => {
    setOwners([...owners, '']);
  };

  const removeOwner = (index: number) => {
    setOwners(owners.filter((_, i) => i !== index));
  };

  const updateOwner = (index: number, value: string) => {
    const newOwners = [...owners];
    newOwners[index] = value;
    setOwners(newOwners);
  };

  const handleDeploy = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setDeployedAddress('');

    // Validation
    const validOwners = owners.filter(o => o.trim() !== '');
    if (validOwners.length === 0) {
      setError('At least one owner is required');
      return;
    }

    for (const owner of validOwners) {
      if (!isAddress(owner)) {
        setError(`Invalid address: ${owner}`);
        return;
      }
    }

    if (requiredConfirmations < 1 || requiredConfirmations > validOwners.length) {
      setError(`Required confirmations must be between 1 and ${validOwners.length}`);
      return;
    }

    if (!walletClient || !publicClient) {
      setError('Wallet not connected');
      return;
    }

    try {
      setIsDeploying(true);

      // Deploy the contract
      const hash = await walletClient.deployContract({
        abi: multiSigWalletABI,
        bytecode: ('0x' + MULTISIG_BYTECODE) as `0x${string}`,
        args: [validOwners as `0x${string}`[], BigInt(requiredConfirmations)],
      });

      // Wait for transaction
      const receipt = await publicClient.waitForTransactionReceipt({ hash });

      if (receipt.contractAddress) {
        setDeployedAddress(receipt.contractAddress);
      } else {
        setError('Failed to deploy contract');
      }
    } catch (err: any) {
      console.error('Deployment error:', err);
      setError(err.message || 'Failed to deploy Safe');
    } finally {
      setIsDeploying(false);
    }
  };

  return (
    <div className="card">
      <div className="flex items-center gap-3 mb-4">
        {onBack && (
          <button
            type="button"
            onClick={onBack}
            className="text-white/60 hover:text-white transition-colors"
          >
            <svg
              className="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M15 19l-7-7 7-7"
              />
            </svg>
          </button>
        )}
        <h2 className="text-lg font-semibold text-white">
          Deploy New Safe on Base
        </h2>
      </div>

      {deployedAddress ? (
        <div className="space-y-4">
          <div className="bg-green-500/10 border border-green-500/20 rounded-lg p-4">
            <p className="text-green-400 font-semibold mb-2">
              Safe Deployed Successfully!
            </p>
            <p className="text-white/60 text-sm mb-2">Contract Address:</p>
            <code className="block bg-black/20 p-2 rounded text-green-400 text-sm break-all">
              {deployedAddress}
            </code>
          </div>
          <button
            onClick={() => {
              setDeployedAddress('');
              setOwners([address || '']);
              setRequiredConfirmations(1);
            }}
            className="btn-secondary w-full"
          >
            Deploy Another Safe
          </button>
        </div>
      ) : (
        <form onSubmit={handleDeploy} className="space-y-4">
          <div>
            <label className="block text-white/60 text-sm mb-2">
              Owners ({owners.length})
            </label>
            <div className="space-y-2">
              {owners.map((owner, index) => (
                <div key={index} className="flex gap-2">
                  <input
                    type="text"
                    value={owner}
                    onChange={(e) => updateOwner(index, e.target.value)}
                    placeholder="0x..."
                    className="input flex-1 font-mono text-sm"
                  />
                  {owners.length > 1 && (
                    <button
                      type="button"
                      onClick={() => removeOwner(index)}
                      className="btn-secondary px-3"
                    >
                      âœ•
                    </button>
                  )}
                </div>
              ))}
            </div>
            <button
              type="button"
              onClick={addOwner}
              className="btn-secondary w-full mt-2 text-sm"
            >
              + Add Owner
            </button>
          </div>

          <div>
            <label className="block text-white/60 text-sm mb-2">
              Required Confirmations
            </label>
            <input
              type="number"
              min="1"
              max={owners.length}
              value={requiredConfirmations}
              onChange={(e) => setRequiredConfirmations(parseInt(e.target.value))}
              className="input w-full"
            />
            <p className="text-white/40 text-xs mt-1">
              Number of owners required to approve a transaction
            </p>
          </div>

          {error && (
            <div className="bg-red-500/10 border border-red-500/20 rounded-lg p-3">
              <p className="text-red-400 text-sm">{error}</p>
            </div>
          )}

          <button
            type="submit"
            disabled={isDeploying}
            className="btn-primary w-full"
          >
            {isDeploying ? 'Deploying...' : 'Deploy Safe'}
          </button>
        </form>
      )}
    </div>
  );
}

// MultiSigWallet bytecode
const MULTISIG_BYTECODE = '60806040523480156200001157600080fd5b5060405162002191380380620021918339810160408190526200003491620002a8565b81518160328211158015620000495750818111155b80156200005557508015155b80156200006157508115155b620000b35760405162461bcd60e51b815260206004820152601360248201527f496e76616c696420726571756972656d656e740000000000000000000000000060448201526064015b60405180910390fd5b60005b8451811015620001d15760026000868381518110620000d957620000d962000382565b6020908102919091018101516001600160a01b031682528101919091526040016000205460ff161580156200013d575060006001600160a01b031685828151811062000129576200012962000382565b60200260200101516001600160a01b031614155b6200017b5760405162461bcd60e51b815260206004820152600d60248201526c24b73b30b634b21037bbb732b960991b6044820152606401620000aa565b60016002600087848151811062000196576200019662000382565b6020908102919091018101516001600160a01b03168252810191909152604001600020805460ff1916911515919091179055600101620000b6565b508351620001e7906003906020870190620001f4565b5050506004555062000398565b8280548282559060005260206000209081019282156200024c579160200282015b828111156200024c57825182546001600160a01b0319166001600160a01b0390911617825560209092019160019091019062000215565b506200025a9291506200025e565b5090565b5b808211156200025a57600081556001016200025f565b634e487b7160e01b600052604160045260246000fd5b80516001600160a01b0381168114620002a357600080fd5b919050565b60008060408385031215620002bc57600080fd5b82516001600160401b0380821115620002d457600080fd5b818501915085601f830112620002e957600080fd5b815160208282111562000300576200030062000275565b8160051b604051601f19603f8301168101818110868211171562000328576200032862000275565b6040529283528183019350848101820192898411156200034757600080fd5b948201945b83861015620003705762000360866200028b565b855294820194938201936200034c565b97909101519698969750505050505050565b634e487b7160e01b600052603260045260246000fd5b611de980620003a86000396000f3fe6080604052600436106101395760003560e01c8063a0e67e2b116100ab578063c01a8c841161006f578063c01a8c8414610430578063c642747414610450578063d74f8edd14610470578063dc8452cd14610485578063e20056e61461049b578063ee22610b146104bb5761017d565b8063a0e67e2b1461038b578063a8abe69a146103ad578063b5dc40c3146103da578063b77bf600146103fa578063ba51a6df146104105761017d565b80063411c81c116100fd5780063411c81c146102a257806354741525146102dd5780637065cb481461030b578063784547a71461032b5780638b51d13f1461034b5780639ace38c21461036b5761017d565b8063025e7c27146101b5578063173825d9146101f257806320ea8d86146102125780632f54bf6e1461023257806333ea3dc8146102725761017d565b3661017d57341561017b5760405134815233907fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c906020015b60405180910390a25b005b341561017b5760405134815233907fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c90602001610172565b3480156101c157600080fd5b506101d56101d0366004611803565b6104db565b6040516001600160a01b0390911681526020015b60405180910390f35b3480156101fe57600080fd5b5061017b61020d366004611838565b610505565b34801561021e57600080fd5b5061017b61022d366004611803565b6106e0565b34801561023e57600080fd5b5061026261024d366004611838565b60026020526000908152604090205460ff1681565b60405190151581526020016101e9565b34801561027e57600080fd5b5061029261028d366004611803565b61082b565b6040516101e99493929190611853565b3480156102ae57600080fd5b506102626102bd3660046118c2565b600160209081526000928352604080842090915290825290205460ff1681565b3480156102e957600080fd5b506102fd6102f83660046118fe565b610903565b6040519081526020016101e9565b34801561031757600080fd5b5061017b610326366004611838565b610976565b34801561033757600080fd5b50610262610346366004611803565b610b28565b34801561035757600080fd5b506102fd610366366004611803565b610bbc565b34801561037757600080fd5b50610292610386366004611803565b610c38565b34801561039757600080fd5b506103a0610cf6565b6040516101e99190611928565b3480156103b957600080fd5b506103cd6103c8366004611975565b610d58565b6040516101e991906119bb565b3480156103e657600080fd5b506103a06103f5366004611803565b610edb565b34801561040657600080fd5b506102fd60055481565b34801561041c57600080fd5b5061017b61042b366004611803565b61109e565b34801561043c57600080fd5b5061017b61044b366004611803565b611167565b34801561045c57600080fd5b506102fd61046b366004611a09565b6112c7565b34801561047c57600080fd5b506102fd603281565b34801561049157600080fd5b506102fd60045481565b3480156104a757600080fd5b5061017b6104b6366004611ad4565b6112e6565b3480156104c757600080fd5b5061017b6104d6366004611803565b6114f6565b600381815481106104eb57600080fd5b6000918252602090912001546001600160a01b0316905081565b33301461052d5760405162461bcd60e51b815260040161052490611afe565b60405180910390fd5b6001600160a01b038116600090815260026020526040902054819060ff166105675760405162461bcd60e51b815260040161052490611b2c565b6001600160a01b0382166000908152600260205260408120805460ff191690555b60035461059790600190611b70565b81101561065c57826001600160a01b0316600382815481106105bb576105bb611b89565b6000918252602090912001546001600160a01b03160361065457600380546105e590600190611b70565b815481106105f5576105f5611b89565b600091825260209091200154600380546001600160a01b03909216918390811061062157610621611b89565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555061065c565b600101610588565b50600380548061066e5761066e611b9f565b600082815260209020810160001990810180546001600160a01b031916905501905560035460045411156106a8576003546106a89061109e565b6040516001600160a01b038316907f8001553a916ef2f495d26a907cc54d96ed840d7bda71e73194bf5a9df7a76b9090600090a25050565b3360008181526002602052604090205460ff1661070f5760405162461bcd60e51b815260040161052490611b2c565b60008281526001602090815260408083203380855292529091205483919060ff166107785760405162461bcd60e51b8152602060048201526019602482015278151c985b9cd858dd1a5bdb881b9bdd0818dbdb999a5c9b5959603a1b6044820152606401610524565b600084815260208190526040902060030154849060ff16156107dc5760405162461bcd60e51b815260206004820152601c60248201527f5472616e73616374696f6e20616c7265616479206578656375746564000000006044820152606401610524565b6000858152600160209081526040808320338085529252808320805460ff191690555187927ff6a317157440607f36269043eb55f1287a5a19ba2216afeab88cd46cbcfb88e991a35050505050565b60008181526020819052604081208054600182015460038301546002840180548695606095879591946001600160a01b0390911693919260ff90911690829061087390611bb5565b80601f016020809104026020016040519081016040528092919081815260200182805461089f90611bb5565b80156108ec5780601f106108c1576101008083540402835291602001916108ec565b820191906000526020600020905b8154815290600101906020018083116108cf57829003601f168201915b505050505091509450945094509450509193509193565b6000805b60055481101561096f57838015610930575060008181526020819052604090206003015460ff16155b806109545750828015610954575060008181526020819052604090206003015460ff165b1561096757610964600183611be9565b91505b600101610907565b5092915050565b3330146109955760405162461bcd60e51b815260040161052490611afe565b6001600160a01b038116600090815260026020526040902054819060ff16156109f75760405162461bcd60e51b81526020600482015260146024820152734f776e657220616c72656164792065786973747360601b6044820152606401610524565b816001600160a01b038116610a1e5760405162461bcd60e51b815260040161052490611bfc565b600354610a2c906001611be9565b60045460328211158015610a405750818111155b8015610a4b57508015155b8015610a5657508115155b610a985760405162461bcd60e51b8152602060048201526013602482015272125b9d985b1a59081c995c5d5a5c995b595b9d606a1b6044820152606401610524565b6001600160a01b038516600081815260026020526040808220805460ff1916600190811790915560038054918201815583527fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b0180546001600160a01b03191684179055517ff39e6e1eb0edcf53c221607b54b00cd28f3196fed0a24994dc308b8f611b682d9190a25050505050565b600080805b600354811015610bb25760008481526001602052604081206003805491929184908110610b5c57610b5c611b89565b60009182526020808320909101546001600160a01b0316835282019290925260400190205460ff1615610b9757610b94600183611be9565b91505b6004548203610baa575060019392505050565b600101610b2d565b5060009392505050565b6000805b600354811015610c325760008381526001602052604081206003805491929184908110610bef57610bef611b89565b60009182526020808320909101546001600160a01b0316835282019290925260400190205460ff1615610c2a57610c27600183611be9565b91505b600101610bc0565b50919050565b6000602081905290815260409020805460018201546002830180546001600160a01b03909316939192610c6a90611bb5565b80601f0160208091040260200160405190810160405280929190818152602001828054610c9690611bb5565b8015610ce35780601f10610cb857610100808354040283529160200191610ce3565b820191906000526020600020905b815481529060010190602001808311610cc657829003601f168201915b5050506003909301549192505060ff1684565b60606003805480602002602001604051908101604052809291908181526020018280548015610d4e57602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311610d30575b5050505050905090565b6060600060055467ffffffffffffffff811115610d7757610d776119f3565b604051908082528060200260200182016040528015610da0578160200160208202803683370190505b5090506000805b600554811015610e2d57858015610dd0575060008181526020819052604090206003015460ff16155b80610df45750848015610df4575060008181526020819052604090206003015460ff165b15610e255780838381518110610e0c57610e0c611b89565b6020908102919091010152610e22600183611be9565b91505b600101610da7565b50610e388787611b70565b67ffffffffffffffff811115610e5057610e506119f3565b604051908082528060200260200182016040528015610e79578160200160208202803683370190505b509250865b86811015610ed057828181518110610e9857610e98611b89565b6020026020010151848983610ead9190611b70565b81518110610ebd57610ebd611b89565b6020908102919091010152600101610e7e565b505050949350505050565b60035460609060009067ffffffffffffffff811115610efc57610efc6119f3565b604051908082528060200260200182016040528015610f25578160200160208202803683370190505b5090506000805b600354811015610ff95760008581526001602052604081206003805491929184908110610f5b57610f5b611b89565b60009182526020808320909101546001600160a01b0316835282019290925260400190205460ff1615610ff15760038181548110610f9b57610f9b611b89565b9060005260206000200160009054906101000a90046001600160a01b0316838381518110610fcb57610fcb611b89565b6001600160a01b0390921660209283029190910190910152610fee600183611be9565b91505b600101610f2c565b508067ffffffffffffffff811115611013576110136119f3565b60405190808252806020026020018201604052801561103c578160200160208202803683370190505b50925060005b818110156110965782818151811061105c5761105c611b89565b602002602001015184828151811061107657611076611b89565b6001600160a01b0390921660209283029190910190910152600101611042565b505050919050565b3330146110bd5760405162461bcd60e51b815260040161052490611afe565b60035481603282118015906110d25750818111155b80156110dd57508015155b80156110e857508115155b61112a5760405162461bcd60e51b8152602060048201526013602482015272125b9d985b1a59081c995c5d5a5c995b595b9d606a1b6044820152606401610524565b60048390556040518381527fa3f1ee9126a074d9326c682f561767f710e927faa811f7a99829d49dc421797a9060200160405180910390a1505050565b3360008181526002602052604090205460ff166111965760405162461bcd60e51b815260040161052490611b2c565b60008281526020819052604090205482906001600160a01b03166111fc5760405162461bcd60e51b815260206004820152601a60248201527f5472616e73616374696f6e20646f6573206e6f742065786973740000000000006044820152606401610524565b60008381526001602090815260408083203380855292529091205484919060ff161561126a5760405162461bcd60e51b815260206004820152601d60248201527f5472616e73616374696f6e20616c726561647920636f6e6669726d65640000006044820152606401610524565b6000858152600160208181526040808420338086529252808420805460ff1916909317909255905187927f4a504a94899432a9846e1aa406dceb1bcfd538bb839071d49d1e5e23f5be30ef91a36112c0856114f6565b5050505050565b60006112d4848484611703565b90506112df81611167565b9392505050565b3330146113055760405162461bcd60e51b815260040161052490611afe565b6001600160a01b038216600090815260026020526040902054829060ff1661133f5760405162461bcd60e51b815260040161052490611b2c565b6001600160a01b038216600090815260026020526040902054829060ff16156113a15760405162461bcd60e51b81526020600482015260146024820152734f776e657220616c72656164792065786973747360601b6044820152606401610524565b826001600160a01b0381166113c85760405162461bcd60e51b815260040161052490611bfc565b60005b60035481101561145b57856001600160a01b0316600382815481106113f2576113f2611b89565b6000918252602090912001546001600160a01b03160361145357846003828154811061142057611420611b89565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555061145b565b6001016113cb565b506001600160a01b03808616600081815260026020526040808220805460ff1990811690915593881682528082208054909416600117909355915190917f8001553a916ef2f495d26a907cc54d96ed840d7bda71e73194bf5a9df7a76b9091a26040516001600160a01b038516907ff39e6e1eb0edcf53c221607b54b00cd28f3196fed0a24994dc308b8f611b682d90600090a25050505050565b3360008181526002602052604090205460ff166115255760405162461bcd60e51b815260040161052490611b2c565b60008281526001602090815260408083203380855292529091205483919060ff1661158e5760405162461bcd60e51b8152602060048201526019602482015278151c985b9cd858dd1a5bdb881b9bdd0818dbdb999a5c9b5959603a1b6044820152606401610524565b600084815260208190526040902060030154849060ff16156115f25760405162461bcd60e51b815260206004820152601c60248201527f5472616e73616374696f6e20616c7265616479206578656375746564000000006044820152606401610524565b6115fb85610b28565b156112c05760008581526020819052604080822060038101805460ff1916600190811790915581549082015492519193926001600160a01b0390911691611646906002860190611c2c565b60006040518083038185875af1925050503d8060008114611683576040519150601f19603f3d011682016040523d82523d6000602084013e611688565b606091505b5050905080156116c25760405187907f33e13ecb54c3076d8e8bb8c2881800a4d972b792045ffae98fdf46df365fed7590600090a26116fa565b60405187907f526441bb6c1aba3c9a4a6ca1d6545da9c2333c8c48343ef398eb858d72b7923690600090a260038201805460ff191690555b50505050505050565b6000836001600160a01b03811661172c5760405162461bcd60e51b815260040161052490611bfc565b600554604080516080810182526001600160a01b03888116825260208083018981528385018981526000606086018190528781529283905294909120835181546001600160a01b031916931692909217825551600182015591519294509160028201906117999082611cf3565b50606091909101516003909101805460ff191691151591909117905560058054600191906000906117cb908490611be9565b909155505060405182907fc0ba8fe4b176c1714197d43b9cc6bcf797a4a7461c5fe8d0ef6e184ae7601e5190600090a2509392505050565b60006020828403121561181557600080fd5b5035919050565b80356001600160a01b038116811461183357600080fd5b919050565b60006020828403121561184a57600080fd5b6112df8261181c565b60018060a01b03851681526000602085602084015260806040840152845180608085015260005b818110156118965786810183015185820160a00152820161187a565b50600060a0828601015260a0601f19601f83011685010192505050821515606083015295945050505050565b600080604083850312156118d557600080fd5b823591506118e56020840161181c565b90509250929050565b8035801515811461183357600080fd5b6000806040838503121561191157600080fd5b61191a836118ee565b91506118e5602084016118ee565b6020808252825182820181905260009190848201906040850190845b818110156119695783516001600160a01b031683529284019291840191600101611944565b50909695505050505050565b6000806000806080858703121561198b57600080fd5b84359350602085013592506119a2604086016118ee565b91506119b0606086016118ee565b905092959194509250565b6020808252825182820181905260009190848201906040850190845b81811015611969578351835292840192918401916001016119d7565b634e487b7160e01b600052604160045260246000fd5b600080600060608486031215611a1e57600080fd5b611a278461181c565b925060208401359150604084013567ffffffffffffffff80821115611a4b57600080fd5b818601915086601f830112611a5f57600080fd5b813581811115611a7157611a716119f3565b604051601f8201601f19908116603f01168101908382118183101715611a9957611a996119f3565b81604052828152896020848701011115611ab257600080fd5b8260208601602083013760006020848301015280955050505050509250925092565b60008060408385031215611ae757600080fd5b611af08361181c565b91506118e56020840161181c565b60208082526014908201527313db9b1e481dd85b1b195d0818d85b8818d85b1b60621b604082015260600190565b60208082526014908201527313dddb995c88191bd95cc81b9bdd08195e1a5cdd60621b604082015260600190565b634e487b7160e01b600052601160045260246000fd5b81810381811115611b8357611b83611b5a565b92915050565b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052603160045260246000fd5b600181811c90821680611bc957607f821691505b602082108103610c3257634e487b7160e01b600052602260045260246000fd5b80820180821115611b8357611b83611b5a565b6020808252601690820152751059191c995cdcc818d85b9b9bdd081899481b9d5b1b60521b604082015260600190565b6000808354611c3a81611bb5565b60018281168015611c525760018114611c6757611c96565b60ff1984168752821515830287019450611c96565b8760005260208060002060005b85811015611c8d5781548a820152908401908201611c74565b50505082870194505b50929695505050505050565b601f821115611cee576000816000526020600020601f850160051c81016020861015611ccb5750805b601f850160051c820191505b81811015611cea57828155600101611cd7565b5050505b505050565b815167ffffffffffffffff811115611d0d57611d0d6119f3565b611d2181611d1b8454611bb5565b84611ca2565b602080601f831160018114611d565760008415611d3e5750858301515b600019600386901b1c1916600185901b178555611cea565b600085815260208120601f198616915b82811015611d8557888601518255948401946001909101908401611d66565b5085821015611da35787850151600019600388901b60f8161c191681555b5050505050600190811b0190555056fea264697066735822122056dc7a60bb5d8cf5dc58ddee22a3265719f7ae10bb950f2eac8bed9393f25ae764736f6c63430008180033';
